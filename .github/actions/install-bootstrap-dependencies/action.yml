name: 'Install bootstrap dependencies'
description: 'Install dependencies to bootstrap MLton'
inputs:
  install-llvm:
    required: true
runs:
  using: "composite"
  steps:
    - name: Install bootstrap dependencies (ubuntu (amd64))
      if: ${{ runner.os == 'Linux' && runner.arch == 'X64' }}
      shell: 'bash'
      run: |
        # Install dependencies (ubuntu (amd64))
        sudo apt-get update
        sudo apt-get install libgmp-dev
        if [[ "${{ inputs.install-llvm }}" == "true" ]]; then sudo apt-get install llvm; fi
        mkdir boot && cd boot
        curl -sOL https://github.com/MLton/mlton/releases/download/on-20241230-release/mlton-20241230-1.amd64-linux.ubuntu-20.04_glibc2.31.tgz
        tar xzf mlton-20241230-1.amd64-linux.ubuntu-20.04_glibc2.31.tgz --exclude='*/share' --strip-components=1
        rm mlton-20241230-1.amd64-linux.ubuntu-20.04_glibc2.31.tgz

    - name: Install bootstrap dependencies (ubuntu (arm64))
      if: ${{ runner.os == 'Linux' && runner.arch == 'ARM64' }}
      shell: 'bash'
      run: |
        # Install dependencies (ubuntu (arm))
        sudo apt-get update
        sudo apt-get install libgmp-dev
        if [[ "${{ inputs.install-llvm }}" == "true" ]]; then sudo apt-get install llvm; fi
        mkdir boot && cd boot
        curl -sOL https://github.com/MLton/mlton/releases/download/on-20241230-release/mlton-20241230-1.arm64-linux.ubuntu-22.04-arm_glibc2.35.tgz
        tar xzf mlton-20241230-1.arm64-linux.ubuntu-22.04-arm_glibc2.35.tgz --exclude='*/share' --strip-components=1
        rm mlton-20241230-1.arm64-linux.ubuntu-22.04-arm_glibc2.35.tgz

    - name: Install bootstrap dependencies (macos (amd64))
      if: ${{ runner.os == 'macOS' && runner.arch == 'X64' }}
      shell: 'bash'
      run: |
        # Install dependencies (macos (amd64))
        # brew update
        brew install -q gmp
        echo "WITH_GMP_DIR=$(brew --prefix)" >> $GITHUB_ENV
        if [[ "${{ inputs.install-llvm }}" == "true" ]]; then brew install llvm; echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH; fi
        mkdir boot && cd boot
        curl -sOL https://github.com/MLton/mlton/releases/download/on-20241230-release/mlton-20241230-1.amd64-darwin.macos-13_gmp-homebrew.tgz
        tar xzf mlton-20241230-1.amd64-darwin.macos-13_gmp-homebrew.tgz --exclude='*/share' --strip-components=1
        rm mlton-20241230-1.amd64-darwin.macos-13_gmp-homebrew.tgz

    - name: Install bootstrap dependencies (macos (arm64))
      if: ${{ runner.os == 'macOS' && runner.arch == 'ARM64' }}
      shell: 'bash'
      run: |
        # Install dependencies (macos (arm64))
        # brew update
        brew install -q gmp
        echo "WITH_GMP_DIR=$(brew --prefix)" >> $GITHUB_ENV
        if [[ "${{ inputs.install-llvm }}" == "true" ]]; then brew install llvm; echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH; fi
        mkdir boot && cd boot
        curl -sOL https://github.com/MLton/mlton/releases/download/on-20241230-release/mlton-20241230-1.arm64-darwin.macos-14_gmp-homebrew.tgz
        tar xzf mlton-20241230-1.arm64-darwin.macos-14_gmp-homebrew.tgz --exclude='*/share' --strip-components=1
        rm mlton-20241230-1.arm64-darwin.macos-14_gmp-homebrew.tgz

    - name: Install bootstrap dependencies (windows (amd64)))
      if: ${{ runner.os == 'Windows' && runner.arch == 'X64' }}
      shell: 'msys2 {0}'
      run: |
        # Install dependencies (windows)
        pacboy --noconfirm -S --needed $(if [ ${MSYSTEM} == "CLANG64" ]; then echo clang:p ; else echo gcc:p; fi) gmp:p gmp-devel:
        if [[ "${{ inputs.install-llvm }}" == "true" ]]; then pacboy --noconfirm -S --needed llvm:p ; fi
        mkdir boot && cd boot
        curl -sOL https://github.com/MLton/mlton/releases/download/on-20241230-release/mlton-20241230-1.amd64-mingw.windows-2022_msys2_${MSYSTEM}.tgz
        tar xzf mlton-20241230-1.amd64-mingw.windows-2022_msys2_${MSYSTEM}.tgz --exclude='*/share' --strip-components=1
        rm mlton-20241230-1.amd64-mingw.windows-2022_msys2_${MSYSTEM}.tgz
