#!/usr/bin/env bash

# This script calls MLton.

set -e
set -x

lib='lib unset'
gcc='gcc'
mlton="$lib/mlton-compile"
world="$lib/world.mlton"
nj='sml'
source "$lib/host-platform"
njHeap="$lib/mlton.$HOST_ARCH-$HOST_OS"

rargs=""
case "$1" in
@MLton)
	shift
	while [ $# -gt 0 -a "$1" != "--" ]; do
		rargs="$rargs $1"
		shift
	done
	shift
	;;
esac

# If $mlton is executable and $world exists and is not older than
# $njHeap (which exists), then use MLton, otherwise use SML/NJ.
doit () {
	if [ -x "$mlton" -a -s "$world" -a ! "$njHeap" -nt "$world" ]; then
		exec "$mlton" @MLton load-world "$world" $rargs -- "$@"
	elif [ -s "$njHeap" ]; then
		exec "$nj" @SMLload="$njHeap" "$@"
	fi
	echo 'Unable to run MLton.  Check that lib is set properly.' >&2
	exit 1
}

# You may need to add -lib-search /path/to/libgmp before the "$@" so that the
# linker can find the gmp.

doit "$lib" \
	-cc "$gcc" \
	"$@"
