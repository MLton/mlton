#!/bin/bash

# This script runs the regression tests in src/regression.
# It also compiles the tests in benchmark/tests

name=`basename $0`

function usage {
	echo >&2 "usage: $name [-cross host] [-run-only]"
	exit 1
}

cross='no'
runOnly='no'
while [ "$#" -gt 0 ]; do
	case "$1" in
	-cross)
		cross='yes'
		shift
		if [ "$#" = 0 ]; then
			usage
		fi
		crossHost="$1"
		shift
		;;
	-run-only)
		runOnly='yes'
		shift
		;;
	*)
		usage
		;;
	esac
done

dir=`dirname $0`
src=`cd $dir/.. && pwd`
bin="$src/build/bin"
mlton="$bin/mlton"
flags='-g -type-check true -native true -gc-check limit -native-reserve-esp true'
if [ $cross = 'yes' ]; then
	flags="$flags -host $crossHost"
fi
cont='callcc.sml callcc2.sml callcc3.sml'
signal='signals.sml'
thread='thread0.sml thread1.sml thread2.sml mutex.sml prodcons.sml same-fringe.sml timeout.sml'
world='world1.sml world2.sml world3.sml world4.sml world5.sml world6.sml'
tmp=/tmp/z.regression.$$
PATH=.:$PATH

cd $src/regression
for f in `ls *.sml`; 
do
	f=`basename $f .sml`
	case "$f" in
	cobol|serialize|testdyn2)
		echo "skipping $f"
	;;
	*)
			echo "testing $f"
		case "$f" in
		exnHistory*)
			extraFlags="-exn-history true"
		;;
		*)
			extraFlags=""
		;;
		esac
		if [ $runOnly = 'no' ]; then
			$mlton $flags $extraFlags $f.sml
			if [ $? -ne 0 ]; then
				echo "compilation of $f failed"
				exit 1
			fi
		fi
		if [ ! -r $f.nonterm -a $cross = 'no' ]; then
			if [ -x $f.exe ]; then
				$f.exe >$tmp 2>&1
				if [ -r $f.ok.cygwin ]; then
					diff $f.ok.cygwin $tmp
				elif [ -r $f.ok ]; then
					diff $f.ok $tmp
				fi
			else
				$f >$tmp 2>&1
				if [ -r $f.ok ]; then
					diff $f.ok $tmp
				fi
			fi
		fi
	;;
	esac
done 
if [ $cross = 'yes' -o $runOnly = 'yes' ]; then
	exit 0
fi
make clean >/dev/null
cd $src/benchmark/tests
for f in `ls *.sml`; do
	f=`basename $f .sml`
	tmpf=/tmp/$f.$$
	case "$f" in
	fxp)
		echo "skipping $f"
	;;
	*)
			echo "testing $f"
		echo "val _ = Main.doit ()" | cat $f.sml - > $tmpf.sml
		$mlton $flags $tmpf.sml
		if [ $? -ne 0 ]; then
			echo "compilation of $f failed"
		fi
		rm -f $tmpf $tmpf.sml
	;;
	esac
done 
make clean > /dev/null
cd $src
for f in mllex mlyacc mlprof; do
    tmpf=/tmp/$f.$$
    cd $src/$f
    case "$f" in
    foobar)
	    echo "skipping $f"
    ;;
    *)
	    echo "testing $f"
	    make -W $f > /dev/null
	    $mlton $flags -o $tmpf $f.cm
	    if [ $? -ne 0 ]; then
			echo "compilation of $f failed"
	    fi
	    rm -f $tmpf
    ;;
    esac
done

rm -f $tmp
