#!/bin/sh

name=`basename $0`

function usage() {
	echo >&2 "usage: $name [-home]"
	exit 1
}

home='no'
while [ "$#" -gt 0 ]; do
	case "$1" in
	-home)
		home='yes'
		shift
		;;
	*)
		usage
		;;
	esac
done

root="$HOME/mlton"
rpms="$root/rpms"
date=`date +%Y%m%d`
version="mlton-$date"
release="1"
src="$rpms/SOURCES/$version/src"

echo 'Cleaning up'
ss rm -rf $rpms/SOURCES/$version*			\
	$rpms/RPMS/i386/$version-$release.i386.rpm 	\
	$rpms/SRPMS/$version-$release.src.rpm
mkdir -p $rpms
cd $rpms
mkdir -p BUILD RPMS/i386 SOURCES SPECS SRPMS

echo 'Checking out sources'
cd $rpms/SOURCES
mkdir $version
cd $version
mkdir bin lib include
cvs -Q co -d src mlton
cvs -Q release src
find src -type d | grep CVS | xargs rm -rf

echo 'Instantiating version numbers'
cd $src/doc
sed "/^Version:/s;.*;Version: $date;" <mlton.spec >z
sed "/^Release:/s;.*;Release: $release;" <z >$rpms/SPECS/mlton.spec
rm -f z
cd $src
for f in doc/web/index.html \
		doc/user-guide/macros.tex \
 		doc/ANNOUNCE \
 		doc/CHANGES \
 		doc/README \
 		mlton/control/control.sml; do
	sed "s/\(.*\)VERSION\(.*\)/\1$version\2/" <$f >z
	mv z $f
done

manvers=`date '+%B %d, %Y'`
cd $src/man
for f in mlprof.1 mlton.1; do
	sed "s/\(.*\)VERSION\(.*\)/\1$manvers\2/" <$f >z
	mv z $f
done

echo 'Creating source tgz'
cd $rpms/SOURCES
ss chown -R root.root $version
tar.write $version | gzip >$version.tgz
ss rm -rf $version

echo 'Building rpms'
cd $rpms/SPECS 
export PATH="$HOME/mlton/bin":$PATH
time rpm --quiet -ba --clean mlton.spec

if [ $home = 'yes' ]; then
	echo 'Building web home'
	cd $root
	rm -rf doc
	echo '  Checking out docs'
	cvs -Q co -d doc mlton/doc
	cvs -Q release doc
	cd $root/doc/web
	make
	cp -p $rpms/RPMS/i386/$version-$release.i386.rpm \
		$rpms/SRPMS/$version-$release.src.rpm .
	find . -type d | egrep (CVS|cvsignore) | xargs rm -rf
	echo '  Building tgz'
	tar.write -x Makefile . | gzip >$root/mlton-home.tgz
	
	echo '  ftp'\''ing'
	remote='hirame'
	cd $root
	(cat | ftp $remote)<<-EOF
		cd www-home
		put mlton-home.tgz
	EOF
fi

echo 'Success'
